<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ëŒ€ì‹œë³´ë“œ : ChatChat</title>
  <link rel="icon" type="image/svg+xml" href="./logo.png">
  <style>
    :root {
      --bg: #121212;
      --text: #e0e0e0;
      --text-sub: #aaaaaa;
      --accent: #3663FF;
      --accent-hover: #4d7aff;
      --danger: #ff5252;
      --danger-hover: #ff6b6b;
      --radius: 16px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: url('back.png') no-repeat center center fixed;
      background-size: cover;
      color: var(--text);
      min-height: 100vh;
      padding: 24px 16px;
      display: flex;
      flex-direction: column;
    }

    main {
      flex: 1;
    }

    h1 {
      text-align: center;
      font-size: 2.1rem;
      font-weight: 700;
      margin-bottom: 1.8rem;
      letter-spacing: -0.6px;
    }

    .container {
      max-width: 520px;
      margin: 0 auto;
    }

    .header-row {
      display: flex;
      align-items: center;
      margin-bottom: 1.6rem;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #ffffff;
      font-size: 1.1rem;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .back-btn:hover {
      opacity: 0.75;
    }

    .back-btn img {
      width: 22px;
      height: 22px;
      filter: brightness(0) invert(1); /* í°ìƒ‰ ì•„ì´ì½˜ ìœ ì§€ìš© (í•„ìš”ì‹œ ì œê±°) */
    }

    .page-title {
      flex: 1;
      text-align: center;
      font-size: 1.45rem;
      font-weight: 700;
      margin: 0 12px;
    }

    button {
      width: 100%;
      padding: 16px;
      font-size: 1.05rem;
      font-weight: 600;
      color: white;
      background: var(--accent);
      border: none;
      border-radius: 30px;
      cursor: pointer;
      transition: all 0.25s ease;
      margin-top: 0.6rem;
    }

    button:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(54,99,255,0.35);
    }

    .secondary {
      background: rgba(80,80,80,0.6);
      color: #ddd;
    }

    .secondary:hover {
      background: rgba(100,100,100,0.8);
    }

    .danger {
      background: var(--danger);
    }

    .danger:hover {
      background: var(--danger-hover);
    }

    ul {
      list-style: none;
      padding: 0;
      margin-top: 1.2rem;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px 10px;
    }

    li {
      background: rgba(40,40,40,0.55);
      border: 1px solid rgba(70,70,70,0.4);
      border-radius: 12px;
      padding: 16px 18px;
      font-size: 0.98rem;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
      backdrop-filter: blur(4px);
      cursor: pointer;
      transition: all 0.18s;
    }

    li:hover {
      background: rgba(60,60,60,0.75);
      transform: translateY(-1px);
    }

    .skeleton {
      background: linear-gradient(90deg, #2a2a2a 25%, #333 50%, #2a2a2a 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s infinite;
      border-radius: 12px;
      height: 72px;
    }

    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .message-content-box {
      background: rgba(30,30,30,0.65);
      border: 1px solid rgba(70,70,70,0.5);
      border-radius: var(--radius);
      padding: 24px 28px;
      backdrop-filter: blur(8px);
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 1.05rem;
      line-height: 1.65;
      min-height: 180px;
      margin: 1.4rem 0;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
    }

    .modal-overlay.show {
      opacity: 1;
      pointer-events: all;
    }

    .modal-content {
      background: rgba(30,30,30,0.95);
      border: 1px solid rgba(80,80,80,0.7);
      border-radius: var(--radius);
      width: 88%;
      max-width: 380px;
      padding: 28px 24px;
      text-align: center;
      transform: scale(0.9);
      opacity: 0;
      transition: all 0.25s ease;
      backdrop-filter: blur(10px);
    }

    .modal-overlay.show .modal-content {
      transform: scale(1);
      opacity: 1;
    }

    .modal-title {
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 1rem;
    }

    .modal-desc {
      color: var(--text-sub);
      font-size: 0.97rem;
      line-height: 1.5;
      margin-bottom: 1.8rem;
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
    }

    .modal-btn {
      flex: 1;
      padding: 14px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .modal-btn.cancel {
      background: rgba(70,70,70,0.8);
      color: #eee;
    }

    .modal-btn.cancel:hover {
      background: rgba(90,90,90,0.95);
    }

    .modal-btn.delete {
      background: var(--danger);
      color: white;
    }

    .modal-btn.delete:hover {
      background: var(--danger-hover);
    }

    footer {
      background: rgba(15,15,15,0.7);
      border-top: 1px solid rgba(50,50,50,0.5);
      padding: 28px 20px;
      text-align: center;
      font-size: 0.92rem;
      color: #777;
      margin-top: 3rem;
      backdrop-filter: blur(10px);
    }

    .footer-link {
      color: #5a8aff;
      text-decoration: none;
      font-weight: 500;
    }

    .footer-link:hover {
      color: #7aa0ff;
      text-decoration: underline;
    }

    @media (max-width: 520px) {
      ul {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

<main>
  <h1>ğŸ’¬ ìµëª… ë©”ì‹œì§€í•¨</h1>
  <div class="container" id="mainContainer"></div>
</main>

<!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div class="modal-overlay" id="deleteModal">
  <div class="modal-content">
    <div class="modal-title">ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
    <div class="modal-desc">ì‚­ì œëœ ë©”ì‹œì§€ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
    <div class="modal-buttons">
      <button class="modal-btn cancel" id="cancelDelete">ì·¨ì†Œ</button>
      <button class="modal-btn delete" id="confirmDelete">ì‚­ì œ</button>
    </div>
  </div>
</div>

<footer>
  <div>
    ì´ ì‚¬ì´íŠ¸ëŠ” <a href="https://sharer.jbjb.r-e.kr/user?id=jbeom&nickname=JB777"
                 target="_blank" class="footer-link">JB777</a>ì´ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤!
  </div>
</footer>

<script>
// â”€â”€ ìŠ¤í¬ë¦½íŠ¸ â”€â”€
const API_BASE = "https://chatchat-api.alexeom97.workers.dev";

function getToken() {
  return localStorage.getItem("authToken");
}

async function api(endpoint, method = "GET", body = null) {
  const headers = { "Content-Type": "application/json" };
  const token = getToken();
  if (token) headers.Authorization = `Bearer ${token}`;
  const res = await fetch(API_BASE + endpoint, {
    method,
    headers,
    body: body ? JSON.stringify(body) : null
  });
  const text = await res.text();
  let data;
  try { data = JSON.parse(text); } catch { data = { error: text }; }
  if (!res.ok) throw new Error(data.error || "ìš”ì²­ ì‹¤íŒ¨");
  return data;
}

function escapeHtml(str) {
  return str.replace(/[&<>"']/g, m => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;" }[m]));
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ í™”ë©´ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderListScreen(username) {
  document.getElementById("mainContainer").innerHTML = `
    <div class="header-row">
      <div class="back-btn" id="backToIndex">
        <img src="re.png" alt="ë’¤ë¡œ"> ë’¤ë¡œ
      </div>
      <div class="page-title">ğŸ“¬ ${username}ì˜ ë©”ì‹œì§€í•¨</div>
    </div>

    <div style="margin:1.8rem 0 1.2rem;">
      <h4 style="margin-bottom:0.8rem;">ë°›ì€ ë©”ì‹œì§€</h4>
    </div>
    <ul id="messagesList">
      ${Array(10).fill().map(() => `<li class="skeleton"></li>`).join("")}
    </ul>
  `;

  document.getElementById("backToIndex").onclick = () => {
    location.href = "index.html";
  };

  loadMessages();
}

function renderDetailScreen(message) {
  const content = escapeHtml(message.content || "");
  const messageId = message.id;

  document.getElementById("mainContainer").innerHTML = `
    <div class="header-row">
      <div class="back-btn" id="backToList">
        <img src="re.png" alt="ë’¤ë¡œ"> ë’¤ë¡œ
      </div>
      <div class="page-title">ë©”ì‹œì§€ ë³´ê¸°</div>
    </div>

    <div class="message-content-box">
      ${content || "<span style='color:#888;'>(ë‚´ìš© ì—†ìŒ)</span>"}
    </div>

    <button class="secondary" id="backToListBtn" style="margin:2.2rem 0 1.2rem;">
      ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
    </button>
    <button class="danger" id="deleteMessageBtn">ë©”ì‹œì§€ ì‚­ì œ</button>
  `;

  const backHandler = () => renderListScreen(localStorage.getItem("currentUsername"));
  document.getElementById("backToList").onclick = backHandler;
  document.getElementById("backToListBtn").onclick = backHandler;

  document.getElementById("deleteMessageBtn").onclick = () => {
    showDeleteModal(messageId);
  };
}

function showDeleteModal(messageId) {
  const modal = document.getElementById("deleteModal");
  modal.classList.add("show");

  const confirmBtn = document.getElementById("confirmDelete");
  const cancelBtn = document.getElementById("cancelDelete");

  // ì´ì „ ì´ë²¤íŠ¸ ì œê±° í›„ ìƒˆë¡œ ë“±ë¡ (ì¤‘ë³µ ë°©ì§€)
  const newConfirm = async () => {
    try {
      await api(`/messages/${messageId}`, "DELETE");
      alert("ë©”ì‹œì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
      closeModal();
      renderListScreen(localStorage.getItem("currentUsername"));
    } catch (err) {
      alert("ì‚­ì œ ì‹¤íŒ¨: " + err.message);
      closeModal();
    }
  };

  const newCancel = () => closeModal();

  confirmBtn.replaceWith(confirmBtn.cloneNode(true)); // ì´ë²¤íŠ¸ ì´ˆê¸°í™”
  cancelBtn.replaceWith(cancelBtn.cloneNode(true));

  document.getElementById("confirmDelete").onclick = newConfirm;
  document.getElementById("cancelDelete").onclick = newCancel;
}

function closeModal() {
  document.getElementById("deleteModal").classList.remove("show");
}

let allMessages = [];

async function loadMessages() {
  const list = document.getElementById("messagesList");
  if (!list) return;

  try {
    const username = localStorage.getItem("currentUsername");
    const { messages = [] } = await api(`/messages?username=${username}`);

    allMessages = messages;

    if (allMessages.length === 0) {
      list.innerHTML = `<li style="text-align:center; color:#888; grid-column: span 2;">ì•„ì§ ë°›ì€ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤</li>`;
      return;
    }

    list.innerHTML = allMessages
      .map((m, i) => {
        const txt = escapeHtml(m.content || "");
        const short = txt.length > 20 ? txt.slice(0,20) + "..." : txt;
        return `<li data-index="${i}">${short}</li>`;
      })
      .join("");

    list.querySelectorAll("li").forEach(el => {
      el.onclick = () => {
        const idx = +el.dataset.index;
        if (!isNaN(idx) && allMessages[idx]) {
          renderDetailScreen(allMessages[idx]);
        }
      };
    });
  } catch (err) {
    list.innerHTML = `<li style="text-align:center; color:#ff5252; grid-column: span 2;">ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</li>`;
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì´ˆê¸° ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(async () => {
  const username = localStorage.getItem("currentUsername");
  if (username && getToken()) {
    renderListScreen(username);
    setInterval(() => {
      if (document.getElementById("messagesList")) loadMessages();
    }, 4000);
  } else {
    location.href = "login.html";
  }
})();
</script>
</body>
</html>

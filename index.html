<!-- index.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìµëª… ë©”ì‹œì§€í•¨</title>
  <style>
    /* ì´ì „ì— ì‚¬ìš©í•˜ë˜ ì˜ˆìœ ìŠ¤íƒ€ì¼ ê·¸ëŒ€ë¡œ ìœ ì§€ */
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: system-ui, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px;
    }
    .container {
      background:white; border-radius:20px; padding:40px; max-width:520px; width:100%;
      box-shadow:0 20px 60px rgba(0,0,0,0.28);
    }
    h1 { color:#667eea; margin-bottom:8px; }
    .subtitle { color:#555; margin-bottom:28px; }
    textarea, input {
      width:100%; padding:12px 14px; border:2px solid #ddd; border-radius:10px;
      font-size:15px; margin-bottom:12px; resize:vertical;
    }
    textarea:focus, input:focus { outline:none; border-color:#667eea; }
    button {
      width:100%; padding:14px; background:#667eea; color:white; border:none;
      border-radius:10px; font-size:16px; font-weight:600; cursor:pointer;
    }
    button:hover { background:#5568d3; }
    .link-box {
      background:#f0f4ff; padding:14px; border-radius:10px; word-break:break-all;
      font-family:ui-monospace,monospace; margin:12px 0; font-size:13.5px;
    }
    .message {
      background:#fff; padding:14px; border-radius:10px; margin-bottom:10px;
      border-left:4px solid #667eea; box-shadow:0 1px 3px rgba(0,0,0,0.08);
    }
    .message-time { color:#888; font-size:12.5px; margin-top:4px; }
    .error { color:#d32f2f; text-align:center; margin-top:8px; }
    .success { color:#2e7d32; text-align:center; margin-top:8px; font-weight:500; }
  </style>
</head>
<body>

<div class="container">

  <!-- ë©”ì‹œì§€ ë³´ë‚´ê¸° í™”ë©´ (ë¹„ë¡œê·¸ì¸ ìƒíƒœ) -->
  <div id="sendArea">
    <h1>ğŸ’¬ ìµëª… ë©”ì‹œì§€ ë³´ë‚´ê¸°</h1>
    <p class="subtitle">ëˆ„êµ°ê°€ì—ê²Œ ì†”ì§í•œ í•œë§ˆë””ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”</p>
    <textarea id="msgContent" rows="5" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”..." maxlength="800"></textarea>
    <button onclick="sendAnonymousMessage()">ë³´ë‚´ê¸°</button>
    <p id="sendResult" class="success"></p>
  </div>

  <!-- ë‚´ ë©”ì‹œì§€í•¨ (ë¡œê·¸ì¸ ìƒíƒœ) -->
  <div id="inboxArea" style="display:none">
    <h1>ğŸ“¬ ë‚´ ìµëª… ë©”ì‹œì§€í•¨</h1>
    <div class="section">
      <h3>ë‚´ ë§í¬</h3>
      <div class="link-box" id="myLink">ë¡œë”©ì¤‘...</div>
      <button onclick="copyMyLink()">ë§í¬ ë³µì‚¬</button>
    </div>
    <div class="section">
      <h3>ë°›ì€ ë©”ì‹œì§€ (<span id="msgCount">0</span>)</h3>
      <div id="messages"></div>
    </div>
    <button style="background:#e53935; margin-top:16px;" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>

</div>

<script>
// ì‹¤ì œ ë°°í¬ ë„ë©”ì¸ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”
const API_BASE = "https://chatchat-api.alexeom97.workers.dev";

async function apiRequest(endpoint, method = 'GET', body = null) {
  try {
    const res = await fetch(API_BASE + endpoint, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: body ? JSON.stringify(body) : null,
      credentials: 'include'   // ì¿ í‚¤ ê¸°ë°˜ ì„¸ì…˜ ì‚¬ìš© ì‹œ
    });
    if (!res.ok) throw new Error(await res.text());
    return await res.json();
  } catch (e) {
    console.error(e);
    throw e;
  }
}

async function checkAuth() {
  try {
    const data = await apiRequest('/me');
    if (data.uid) {
      showInbox(data);
      return true;
    }
  } catch {}
  showSendForm();
  return false;
}

function showSendForm() {
  document.getElementById('sendArea').style.display = 'block';
  document.getElementById('inboxArea').style.display = 'none';
}

function showInbox(userData) {
  document.getElementById('sendArea').style.display = 'none';
  document.getElementById('inboxArea').style.display = 'block';

  const link = `${location.origin}${location.pathname}?u=${userData.uid}`;
  document.getElementById('myLink').textContent = link;

  loadMessages();
}

async function loadMessages() {
  try {
    const { messages = [] } = await apiRequest('/messages');
    const container = document.getElementById('messages');
    container.innerHTML = '';

    if (messages.length === 0) {
      container.innerHTML = '<p style="color:#888;text-align:center">ì•„ì§ ë°›ì€ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
    } else {
      messages.sort((a,b) => b.createdAt - a.createdAt);
      messages.forEach(m => {
        const div = document.createElement('div');
        div.className = 'message';
        div.innerHTML = `
          <div>${m.content.replace(/\n/g,'<br>')}</div>
          <div class="message-time">${new Date(m.createdAt).toLocaleString('ko-KR')}</div>
        `;
        container.appendChild(div);
      });
    }

    document.getElementById('msgCount').textContent = messages.length;
  } catch (e) {
    alert('ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
  }
}

window.sendAnonymousMessage = async () => {
  const content = document.getElementById('msgContent').value.trim();
  if (!content) return alert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');

  const params = new URLSearchParams(location.search);
  const toUid = params.get('u');

  if (!toUid) return alert('ì˜ëª»ëœ ë§í¬ì…ë‹ˆë‹¤');

  try {
    await apiRequest('/send', 'POST', { toUid, content });
    document.getElementById('sendResult').textContent = 'âœ… ë©”ì‹œì§€ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!';
    document.getElementById('msgContent').value = '';
  } catch (e) {
    alert('ì „ì†¡ ì‹¤íŒ¨: ' + e.message);
  }
};

window.copyMyLink = () => {
  navigator.clipboard.writeText(document.getElementById('myLink').textContent)
    .then(() => alert('ë§í¬ ë³µì‚¬ ì™„ë£Œ!'));
};

window.logout = async () => {
  try {
    await apiRequest('/logout', 'POST');
    location.reload();
  } catch {}
};

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì¸ì¦ ìƒíƒœ í™•ì¸
checkAuth();
</script>
</body>
</html>
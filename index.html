
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ìµëª… ë©”ì‹œì§€í•¨</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 20px auto; padding: 0 15px; }
    textarea { width: 100%; height: 100px; margin: 10px 0; }
    button { padding: 10px 16px; margin: 5px; }
    ul { list-style: none; padding: 0; }
    li { background: #f0f0f0; margin: 10px 0; padding: 12px; border-radius: 8px; }
    #dashboard { border-top: 1px solid #ddd; padding-top: 20px; }
  </style>
</head>
<body>
  <h1>ğŸ’¬ ìµëª… ë©”ì‹œì§€í•¨</h1>

  <div id="sendForm">
    <p>ëˆ„êµ°ê°€ì—ê²Œ ìµëª…ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”!</p>
    <textarea id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
    <button onclick="sendMessage()">ìµëª… ì „ì†¡</button>
    <p id="sendStatus" style="color: green;"></p>
    <p><a href="login.html">ë¡œê·¸ì¸í•´ì„œ ë‚´ ë©”ì‹œì§€í•¨ ë³´ê¸°</a></p>
  </div>

  <div id="dashboard" style="display:none">
    <h3>ë‚´ ìµëª… ë©”ì‹œì§€í•¨</h3>
    <p><strong>ë‚´ ë§í¬ ê³µìœ í•˜ê¸°:</strong><br>
      <span id="userLink" style="word-break:break-all; font-family:monospace;"></span>
    </p>
    <button onclick="copyLink()">ë§í¬ ë³µì‚¬</button>
    <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    
    <h4>ë°›ì€ ë©”ì‹œì§€</h4>
    <ul id="messagesList"></ul>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getDatabase, ref, push, query, orderByChild, equalTo, onValue } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCi0cus6PFFospMymbmILW7jHFu3OBoABY",
      authDomain: "chatchat-98586.firebaseapp.com",
      databaseURL: "https://chatchat-98586-default-rtdb.firebaseio.com",
      projectId: "chatchat-98586",
      storageBucket: "chatchat-98586.firebasestorage.app",
      messagingSenderId: "112409356117",
      appId: "1:112409356117:web:b0c92c82a863ad989371dc"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const params = new URLSearchParams(location.search);
    const targetUid = params.get("u");

    let currentUser = null;

    onAuthStateChanged(auth, (user) => {
      currentUser = user;

      if (user) {
        sendForm.style.display = "none";
        dashboard.style.display = "block";

        const myLink = `${location.origin}${location.pathname}?u=${user.uid}`;
        userLink.textContent = myLink;

        loadMessages();
      } else {
        sendForm.style.display = "block";
        dashboard.style.display = "none";
      }
    });

    window.sendMessage = async () => {
      const content = messageInput.value.trim();
      if (!content || !targetUid) {
        sendStatus.textContent = "ë§í¬ì— ëŒ€ìƒì´ ì—†ê±°ë‚˜ ë©”ì‹œì§€ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.";
        sendStatus.style.color = "red";
        return;
      }

      try {
        await push(ref(db, "messages"), {
          toUid: targetUid,
          content,
          createdAt: Date.now()
        });
        sendStatus.textContent = "âœ… ìµëª…ìœ¼ë¡œ ì „ì†¡ ì™„ë£Œ!";
        sendStatus.style.color = "green";
        messageInput.value = "";
      } catch (e) {
        sendStatus.textContent = "ì „ì†¡ ì‹¤íŒ¨: " + e.message;
        sendStatus.style.color = "red";
      }
    };

    function loadMessages() {
      if (!currentUser) return;

      const messagesRef = ref(db, "messages");
      const q = query(messagesRef, orderByChild("toUid"), equalTo(currentUser.uid));

      // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (ìƒˆ ë©”ì‹œì§€ ì˜¬ ë•Œ ìë™ ì¶”ê°€)
      onValue(q, (snapshot) => {
        messagesList.innerHTML = "";
        if (snapshot.exists()) {
          snapshot.forEach((childSnapshot) => {
            const msg = childSnapshot.val();
            const li = document.createElement("li");
            li.textContent = msg.content;
            messagesList.appendChild(li);
          });
        } else {
          messagesList.innerHTML = "<li style='color:#999'>ì•„ì§ ë°›ì€ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤...</li>";
        }
      }, (error) => {
        console.error("ë©”ì‹œì§€ ë¡œë“œ ì˜¤ë¥˜:", error);
        messagesList.innerHTML = "<li style='color:red'>ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>";
      });
    }

    window.copyLink = () => {
      navigator.clipboard.writeText(userLink.textContent)
        .then(() => alert("ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"))
        .catch(() => alert("ë³µì‚¬ ì‹¤íŒ¨"));
    };

    window.logout = async () => {
      await signOut(auth);
      location.href = "login.html";
    };
  </script>
</body>
</html>
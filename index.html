<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìµëª… ë©”ì‹œì§€í•¨</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      color:#333;
    }
    .container {
      background:white;
      border-radius:20px;
      padding:40px;
      max-width:520px;
      width:100%;
      box-shadow:0 20px 60px rgba(0,0,0,0.25);
    }
    h1 { color:#667eea; margin-bottom:12px; text-align:center; }
    .subtitle { color:#555; margin-bottom:28px; text-align:center; }
    textarea, input {
      width:100%;
      padding:14px;
      border:2px solid #ddd;
      border-radius:10px;
      font-size:15px;
      margin-bottom:16px;
      resize:vertical;
    }
    textarea:focus, input:focus { outline:none; border-color:#667eea; }
    button {
      width:100%;
      padding:14px;
      background:#667eea;
      color:white;
      border:none;
      border-radius:10px;
      font-size:16px;
      font-weight:600;
      cursor:pointer;
    }
    button:hover { background:#5568d3; }
    .link-box {
      background:#f0f4ff;
      padding:14px;
      border-radius:10px;
      word-break:break-all;
      font-family:monospace;
      margin:12px 0;
      font-size:14px;
    }
    .message {
      background:#fff;
      padding:16px;
      border-radius:10px;
      margin-bottom:12px;
      border-left:4px solid #667eea;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
    }
    .message-time { color:#777; font-size:13px; margin-top:6px; }
    .status { text-align:center; margin:12px 0; font-weight:500; }
    .success { color:#2e7d32; }
    .error { color:#d32f2f; }
    .logout-btn { background:#e53935; margin-top:20px; }
    .logout-btn:hover { background:#c62828; }
  </style>
</head>
<body>

<!-- ğŸ”¥ ì´ divê°€ ì—†ì–´ì„œ í° í™”ë©´ì´ì—ˆë˜ ê±°ì„ -->
<div class="container" id="mainContainer"></div>

<script>
const API_BASE = "https://chatchat-api.alexeom97.workers.dev";

function getToken() {
  return localStorage.getItem("authToken");
}
function setToken(token) {
  if (token) localStorage.setItem("authToken", token);
  else localStorage.removeItem("authToken");
}

async function apiRequest(endpoint, method = "GET", body = null) {
  const token = getToken();
  const headers = { "Content-Type": "application/json" };
  if (token) headers.Authorization = `Bearer ${token}`;

  const res = await fetch(API_BASE + endpoint, {
    method,
    headers,
    body: body ? JSON.stringify(body) : null
  });

  if (!res.ok) {
    const text = await res.text();
    throw new Error(text || "ìš”ì²­ ì‹¤íŒ¨");
  }
  return await res.json();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë³´ë‚´ê¸° í™”ë©´ â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showSendForm(targetUid = null) {
  const container = document.getElementById("mainContainer");
  container.innerHTML = `
    <h1>ğŸ’¬ ìµëª… ë©”ì‹œì§€ ë³´ë‚´ê¸°</h1>
    <p class="subtitle">ëˆ„êµ°ê°€ì—ê²Œ ì†”ì§í•œ í•œë§ˆë””ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”</p>
    <textarea id="msgContent" rows="6" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”..." maxlength="1000"></textarea>
    <button onclick="sendMessage('${targetUid || ''}')">ë³´ë‚´ê¸°</button>
    <p id="sendStatus" class="status"></p>
    <p style="text-align:center;margin-top:20px;">
      ë‚˜ë§Œì˜ ë©”ì‹œì§€í•¨ ë§Œë“¤ê¸° â†’
      <a href="/login.html" style="color:#667eea;font-weight:600;">ë¡œê·¸ì¸</a>
    </p>
  `;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë‚´ ëŒ€ì‹œë³´ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showMyDashboard(user) {
  const container = document.getElementById("mainContainer");
  const myLink = `${location.origin}${location.pathname}?u=${user.uid}`;

  container.innerHTML = `
    <h1>ğŸ“¬ ë‚˜ì˜ ìµëª… ë©”ì‹œì§€í•¨</h1>
    <div style="margin:24px 0;">
      <h3>ë‚´ ë§í¬</h3>
      <div class="link-box" id="myLink">${myLink}</div>
      <button onclick="copyLink()">ë§í¬ ë³µì‚¬</button>
    </div>
    <h3 style="margin-top:28px;">ë°›ì€ ë©”ì‹œì§€ (<span id="msgCount">0</span>)</h3>
    <div id="messagesList">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
  `;

  loadMessages();
}

async function loadMessages() {
  try {
    const { messages = [] } = await apiRequest("/messages");
    const list = document.getElementById("messagesList");
    const count = document.getElementById("msgCount");

    count.textContent = messages.length;

    if (messages.length === 0) {
      list.innerHTML = '<p style="color:#888;text-align:center;padding:30px 0;">ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ì–´ìš”</p>';
      return;
    }

    list.innerHTML = messages.map(m => `
      <div class="message">
        <div>${m.content.replace(/\n/g, "<br>")}</div>
        <div class="message-time">${new Date(m.createdAt || Date.now()).toLocaleString("ko-KR")}</div>
      </div>
    `).join("");
  } catch (e) {
    document.getElementById("messagesList").innerHTML = "<p>ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</p>";
  }
}

window.sendMessage = async (toUid) => {
  const content = document.getElementById("msgContent")?.value?.trim();
  const status = document.getElementById("sendStatus");

  if (!content || !toUid) {
    status.textContent = "ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”";
    status.className = "status error";
    return;
  }

  try {
    await apiRequest("/send", "POST", { toUid, content });
    status.textContent = "âœ… ì „ì†¡ ì™„ë£Œ!";
    status.className = "status success";
    document.getElementById("msgContent").value = "";
  } catch (e) {
    status.textContent = "ì „ì†¡ ì‹¤íŒ¨: " + e.message;
    status.className = "status error";
  }
};

window.copyLink = () => {
  const link = document.getElementById("myLink")?.textContent;
  if (!link) return;
  navigator.clipboard.writeText(link).then(() => alert("ë³µì‚¬ë¨!"));
};

window.logout = () => {
  setToken(null);
  location.reload();
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€ í˜ì´ì§€ ë¡œë“œ ë¶„ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async () => {
  const params = new URLSearchParams(location.search);
  const targetUid = params.get("u");

  if (targetUid) {
    showSendForm(targetUid);
    return;
  }

  try {
    const user = await apiRequest("/me");
    if (user?.uid) showMyDashboard(user);
    else showSendForm();
  } catch (e) {
    console.error("ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:", e);
    showSendForm();
  }
})();
</script>
</body>
</html>

<!-- index.html -->
<!-- ... (ê¸°ì¡´ ìŠ¤íƒ€ì¼ì€ ê·¸ëŒ€ë¡œ ìœ ì§€) ... -->

<script>
// ì‹¤ì œ Worker URL
const API_BASE = "https://chatchat-api.alexeom97.workers.dev";

function getToken() {
  return localStorage.getItem("authToken");
}

function setToken(token) {
  if (token) localStorage.setItem("authToken", token);
  else localStorage.removeItem("authToken");
}

async function apiRequest(endpoint, method = "GET", body = null) {
  const token = getToken();

  const headers = {
    "Content-Type": "application/json",
  };
  if (token) headers.Authorization = `Bearer ${token}`;

  const res = await fetch(API_BASE + endpoint, {
    method,
    headers,
    body: body ? JSON.stringify(body) : null
  });

  if (!res.ok) {
    const errText = await res.text();
    throw new Error(errText || "ìš”ì²­ ì‹¤íŒ¨");
  }

  return await res.json();
}

// â”€â”€ ë³´ë‚´ê¸° í™”ë©´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showSendForm(targetUid = null) {
  document.getElementById("mainContainer").innerHTML = `
    <h1>ğŸ’¬ ìµëª… ë©”ì‹œì§€ ë³´ë‚´ê¸°</h1>
    <p class="subtitle">ëˆ„êµ°ê°€ì—ê²Œ ì†”ì§í•œ í•œë§ˆë””ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”</p>
    <textarea id="msgContent" rows="6" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”..." maxlength="1000"></textarea>
    <button onclick="sendMessage('${targetUid || ''}')">ë³´ë‚´ê¸°</button>
    <p id="sendStatus" class="status"></p>
    <p style="text-align:center;margin-top:20px;">
      ë‚˜ë§Œì˜ ë©”ì‹œì§€í•¨ ë§Œë“¤ê¸° â†’
      <a href="/login.html" style="color:#667eea;font-weight:600;">ë¡œê·¸ì¸</a>
    </p>
  `;
}

// â”€â”€ ë‚´ ëŒ€ì‹œë³´ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showMyDashboard() {
  const myLink = `${location.origin}${location.pathname}?u=temp-uid-placeholder`; // ì‹¤ì œ uidë¡œ êµì²´ í•„ìš”

  document.getElementById("mainContainer").innerHTML = `
    <h1>ğŸ“¬ ë‚˜ì˜ ìµëª… ë©”ì‹œì§€í•¨</h1>
    <div style="margin:24px 0;">
      <h3>ë‚´ ë§í¬</h3>
      <div class="link-box">${myLink}</div>
      <button onclick="navigator.clipboard.writeText('${myLink}').then(()=>alert('ë³µì‚¬ë¨!'))">ë§í¬ ë³µì‚¬</button>
    </div>
    <h3 style="margin-top:28px;">ë°›ì€ ë©”ì‹œì§€</h3>
    <div id="messagesList">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
  `;

  loadMessages();
}

async function loadMessages() {
  try {
    const { messages = [] } = await apiRequest("/messages");
    document.getElementById("messagesList").innerHTML =
      messages.length === 0
        ? '<p style="color:#888;text-align:center">ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤</p>'
        : messages.map(m => `<div class="message">${m.content}</div>`).join("");
  } catch (e) {
    document.getElementById("messagesList").innerHTML = "<p>ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</p>";
  }
}

window.sendMessage = async (toUid) => {
  const content = document.getElementById("msgContent")?.value?.trim();
  const status = document.getElementById("sendStatus");

  if (!content || !toUid) {
    status.textContent = "ì…ë ¥ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”";
    status.className = "status error";
    return;
  }

  try {
    await apiRequest("/send", "POST", { toUid, content });
    status.textContent = "âœ… ì „ì†¡ ì™„ë£Œ!";
    status.className = "status success";
    document.getElementById("msgContent").value = "";
  } catch (e) {
    status.textContent = "ì „ì†¡ ì‹¤íŒ¨: " + e.message;
    status.className = "status error";
  }
};

window.logout = () => {
  setToken(null);
  location.reload();
};

// â”€â”€ í˜ì´ì§€ ë¡œë“œ ì‹œ íŒë‹¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async () => {
  const params = new URLSearchParams(location.search);
  const targetUid = params.get("u");

  if (targetUid) {
    // ?u=xxx ê°€ ìˆìœ¼ë©´ â†’ ë¬´ì¡°ê±´ ë³´ë‚´ê¸° í™”ë©´
    showSendForm(targetUid);
    return;
  }

  // uid ì—†ìŒ â†’ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
  try {
    const user = await apiRequest("/me");
    if (user?.uid) {
      showMyDashboard();
    } else {
      showSendForm();
    }
  } catch (e) {
    console.error("ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:", e);
    showSendForm();
  }
})();
</script>
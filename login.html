<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìµëª… ë©”ì‹œì§€í•¨</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      color:#333;
    }
    .container {
      background:white;
      border-radius:20px;
      padding:40px;
      max-width:520px;
      width:100%;
      box-shadow:0 20px 60px rgba(0,0,0,0.25);
    }
    h1 { color:#667eea; margin-bottom:12px; text-align:center; }
    .subtitle { color:#555; margin-bottom:28px; text-align:center; }
    textarea, input {
      width:100%;
      padding:14px;
      border:2px solid #ddd;
      border-radius:10px;
      font-size:15px;
      margin-bottom:16px;
      resize:vertical;
    }
    textarea:focus, input:focus { outline:none; border-color:#667eea; }
    button {
      width:100%;
      padding:14px;
      background:#667eea;
      color:white;
      border:none;
      border-radius:10px;
      font-size:16px;
      font-weight:600;
      cursor:pointer;
    }
    button:hover { background:#5568d3; }
    .link-box {
      background:#f0f4ff;
      padding:14px;
      border-radius:10px;
      word-break:break-all;
      font-family:monospace;
      margin:12px 0;
      font-size:14px;
    }
    .message {
      background:#fff;
      padding:16px;
      border-radius:10px;
      margin-bottom:12px;
      border-left:4px solid #667eea;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
    }
    .message-time { color:#777; font-size:13px; margin-top:6px; }
    .status { text-align:center; margin:12px 0; font-weight:500; }
    .success { color:#2e7d32; }
    .error { color:#d32f2f; }
    .logout-btn { background:#e53935; margin-top:20px; }
    .logout-btn:hover { background:#c62828; }
  </style>
</head>
<body>

<div class="container" id="mainContainer">
  <!-- ë™ì ìœ¼ë¡œ ë‚´ìš©ì´ ë°”ë€œ -->
</div>

<script>
// ì‹¤ì œ Worker URLë¡œ ë³€ê²½í•˜ì„¸ìš”
const API_BASE = "https://chatchat-api.alexeom97.workers.dev";

async function apiRequest(endpoint, method = 'GET', body = null) {
  try {
    const res = await fetch(API_BASE + endpoint, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: body ? JSON.stringify(body) : null,
      credentials: 'include'
    });
    if (!res.ok) throw new Error(await res.text());
    return await res.json();
  } catch (e) {
    console.error(e);
    throw e;
  }
}

function showSendForm(targetUid = null) {
  const container = document.getElementById('mainContainer');
  container.innerHTML = `
    <h1>ğŸ’¬ ìµëª… ë©”ì‹œì§€ ë³´ë‚´ê¸°</h1>
    <p class="subtitle">ëˆ„êµ°ê°€ì—ê²Œ ì†”ì§í•œ ë§ˆìŒì„ ì „í•´ë³´ì„¸ìš”</p>
    <textarea id="msgContent" rows="6" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”..." maxlength="1000"></textarea>
    <button onclick="sendMessage('${targetUid || ''}')">ìµëª…ìœ¼ë¡œ ë³´ë‚´ê¸°</button>
    <p id="sendStatus" class="status"></p>
    <p style="text-align:center; margin-top:20px; color:#555;">
      ë‚˜ë§Œì˜ ë©”ì‹œì§€í•¨ ë§Œë“¤ê¸° <a href="/login.html" style="color:#667eea; font-weight:600;">ë¡œê·¸ì¸</a>
    </p>
  `;
}

function showMyDashboard(user) {
  const container = document.getElementById('mainContainer');
  const myLink = `${location.origin}${location.pathname}?u=${user.uid}`;
  
  container.innerHTML = `
    <h1>ğŸ“¬ ë‚˜ì˜ ìµëª… ë©”ì‹œì§€í•¨</h1>
    <p class="subtitle">ì¹œêµ¬ë“¤ì´ ë³´ë‚¸ ìµëª… ë©”ì‹œì§€ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”</p>
    
    <div style="margin:24px 0;">
      <h3 style="margin-bottom:8px;">ë‚´ ê³µìœ  ë§í¬</h3>
      <div class="link-box" id="myLink">${myLink}</div>
      <button onclick="copyLink()">ë§í¬ ë³µì‚¬í•˜ê¸°</button>
    </div>
    
    <h3 style="margin:28px 0 12px;">ë°›ì€ ë©”ì‹œì§€ (<span id="msgCount">0</span>)</h3>
    <div id="messagesList"></div>
    
    <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
  `;
  
  loadMyMessages();
}

async function loadMyMessages() {
  try {
    const { messages = [] } = await apiRequest('/messages');
    const countEl = document.getElementById('msgCount');
    const listEl = document.getElementById('messagesList');
    
    countEl.textContent = messages.length;
    
    if (messages.length === 0) {
      listEl.innerHTML = '<p style="color:#888;text-align:center;padding:40px 0;">ì•„ì§ ë°›ì€ ë©”ì‹œì§€ê°€ ì—†ì–´ìš” :(</p>';
      return;
    }
    
    listEl.innerHTML = '';
    messages.sort((a,b) => b.createdAt - a.createdAt).forEach(m => {
      const div = document.createElement('div');
      div.className = 'message';
      div.innerHTML = `
        <div>${m.content.replace(/\n/g, '<br>')}</div>
        <div class="message-time">${new Date(m.createdAt).toLocaleString('ko-KR')}</div>
      `;
      listEl.appendChild(div);
    });
  } catch (e) {
    alert('ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

window.sendMessage = async (targetUid) => {
  const content = document.getElementById('msgContent')?.value?.trim();
  const status = document.getElementById('sendStatus');
  
  if (!content) {
    status.textContent = 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!';
    status.className = 'status error';
    return;
  }
  
  if (!targetUid) {
    status.textContent = 'ì˜ëª»ëœ ë§í¬ì…ë‹ˆë‹¤.';
    status.className = 'status error';
    return;
  }
  
  try {
    await apiRequest('/send', 'POST', { toUid: targetUid, content });
    status.textContent = 'âœ… ë©”ì‹œì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!';
    status.className = 'status success';
    document.getElementById('msgContent').value = '';
  } catch (e) {
    status.textContent = 'ì „ì†¡ ì‹¤íŒ¨: ' + e.message;
    status.className = 'status error';
  }
};

window.copyLink = () => {
  const link = document.getElementById('myLink')?.textContent;
  if (link) {
    navigator.clipboard.writeText(link).then(() => {
      alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    });
  }
};

window.logout = async () => {
  try {
    await apiRequest('/logout', 'POST');
  } catch {}
  location.reload();
};

// í˜ì´ì§€ ë¡œë“œ ì‹œ íŒë‹¨ ë¡œì§
(async () => {
  const params = new URLSearchParams(location.search);
  const targetUid = params.get('u');

  if (targetUid) {
    // ë§í¬ì— uid ìˆìŒ â†’ ë¬´ì¡°ê±´ ë³´ë‚´ê¸° í™”ë©´
    showSendForm(targetUid);
  } else {
    // uid ì—†ìŒ â†’ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ í›„ ë‚´ ëŒ€ì‹œë³´ë“œ or ë¡œê·¸ì¸ ìœ ë„
    try {
      const user = await apiRequest('/me');
      if (user.uid) {
        showMyDashboard(user);
      } else {
        showSendForm();
      }
    } catch {
      showSendForm();
    }
  }
})();
</script>
</body>
</html>